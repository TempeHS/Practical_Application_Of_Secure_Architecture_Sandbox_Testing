services:
  # Dedicated sandbox environment for cybersecurity tools
  sandbox:
    build:
      context: ..
      dockerfile: docker/Dockerfile.minimal
    container_name: cybersec_sandbox
    hostname: sandbox
    networks:
      - sandbox_network
    volumes:
      # Mount workspace for development
      - /workspaces/Secure_Architecture_Sandbox_Testing_Environment:/workspace:cached
      # Persistent volumes for data
      - sandbox_reports:/workspace/reports
      - sandbox_logs:/workspace/logs
    ports:
      - "8080:8080" # Analysis web interface
    environment:
      - PYTHONPATH=/workspace/src
      - SANDBOX_MODE=educational
    # Security settings appropriate for educational use
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW # For nmap and network tools
      - NET_ADMIN # For network analysis
    # Resource limits for Codespaces
    mem_limit: 512m
    cpus: 0.5
    restart: unless-stopped
    # Keep container running and allow interactive access
    stdin_open: true
    tty: true

  # PWA Flask application - completely independent
  unsecure-pwa:
    build:
      context: ..
      dockerfile: docker/Dockerfile.unsecure-pwa
    container_name: unsecure_pwa
    hostname: unsecure-pwa
    networks:
      - sandbox_network
    ports:
      - "5000:5000" # Map host 5000 to PWA Flask app port
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
    restart: unless-stopped
    # NO depends_on - runs independently

  # Vulnerable Flask app - separate service
  vulnerable-flask:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vulnerable-flask
    container_name: vulnerable_flask
    hostname: vulnerable-flask
    networks:
      - sandbox_network
    ports:
      - "9090:9090" # Map host 9090 to vulnerable Flask app port
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
    restart: unless-stopped
    # NO depends_on - runs independently

  # Student uploads Flask app - independent service
  student-uploads:
    build:
      context: ..
      dockerfile: docker/Dockerfile.student-uploads
    container_name: student_uploads
    hostname: student-uploads
    networks:
      - sandbox_network
    ports:
      - "8000:8000" # Map host 8000 to student uploads Flask app port
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
    restart: unless-stopped
    # NO depends_on - runs independently

  # Vulnerable Node.js app - independent service
  vulnerable-nodejs:
    build:
      context: ..
      dockerfile: docker/Dockerfile.vulnerable-nodejs
    container_name: vulnerable_nodejs
    hostname: vulnerable-nodejs
    networks:
      - sandbox_network
    ports:
      - "3000:3000" # Map host 3000 to vulnerable Node.js app port
    environment:
      - NODE_ENV=development
      - PORT=3000
    restart: unless-stopped
    # NO depends_on - runs independently

networks:
  sandbox_network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    # Enable isolation for educational security testing
    internal: false

volumes:
  sandbox_reports:
    driver: local
  sandbox_logs:
    driver: local
